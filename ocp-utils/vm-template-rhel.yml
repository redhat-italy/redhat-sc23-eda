kind: "Template"
apiVersion: "template.openshift.io/v1"
metadata:
  name: "rhel9-server"
  namespace: "sc23-eda-demo"
  labels:
    app.kubernetes.io/part-of: "hyperconverged-cluster"
    template.kubevirt.io/version: "v0.25.0"
    app.kubernetes.io/version: 4.13.4
    template.kubevirt.io/type: "vm"
    app.kubernetes.io/component: "templating"
    app.kubernetes.io/ocp-by: "ssp-operator"
    app.kubernetes.io/name: "custom-templates"
    os.template.kubevirt.io/rhel9.0: "true"
    os.template.kubevirt.io/rhel9.1: "true"
    os.template.kubevirt.io/rhel9.2: "true"
    vm.kubevirt.io/template.namespace: "openshift"
    workload.template.kubevirt.io/server: "true"
  annotations:
    openshift.io/display-name: "Red Hat Summit Connect - RHEL9"
    defaults.template.kubevirt.io/disk: "rootdisk"
    description: "Template for Red Hat Enterprise Linux 9 VM or newer. A PVC with the RHEL disk image must be available."
    iconClass: "icon-rhel"
    openshift.io/provider-display-name: ""
    name.os.template.kubevirt.io/rhel9.0: "Red Hat Enterprise Linux 9.0 or higher"

objects:
  - apiVersion: "kubevirt.io/v1"
    kind: "VirtualMachine"
    metadata:
      annotations:
        vm.kubevirt.io/validations: "[\n  {\n    \"name\": \"minimal-required-memory\",\n    \"path\": \"jsonpath::.spec.domain.resources.requests.memory\",\n    \"rule\": \"integer\",\n    \"message\": \"This VM requires more memory.\",\n    \"min\": 1610612736\n  }\n]\n"
      labels:
        app: "${NAME}"
        vm.kubevirt.io/template: "rhel9-server"
        vm.kubevirt.io/template.revision: "1"
      name: "${NAME}"
    spec:
      dataVolumeTemplates:
        - apiVersion: cdi.kubevirt.io/v1beta1
          kind: DataVolume
          metadata:
            name: '${NAME}'
          spec:
            sourceRef:
              kind: DataSource
              name: 'rhel9'
              namespace: 'openshift-virtualization-os-images'
            storage:
              resources:
                requests:
                  storage: 30Gi
        - metadata:
            name: "${NAME}-additional-disk"
          spec:
            storage:
              resources:
                requests:
                  storage: "5Gi"
            preallocation: false
            source:
              blank: {}
      running: false
      template:
        metadata:
          annotations:
            vm.kubevirt.io/flavor: "medium"
            vm.kubevirt.io/os: "rhel9"
            vm.kubevirt.io/workload: "server"
          labels:
            kubevirt.io/domain: "${NAME}"
            kubevirt.io/size: "medium"
        spec:
          domain:
            cpu:
              cores: ${{VM_CPU}}
              sockets: 1
              threads: 1
            devices:
              disks:
                - name: "rootdisk"
                  disk:
                    bus: "virtio"
                  bootOrder: 1
                - disk:
                    bus: "virtio"
                  name: "cloudinitdisk"
                  bootOrder: 2
                - name: "additional-disk"
                  disk:
                    bus: "virtio"
              interfaces:
                - masquerade: {}
                  model: "virtio"
                  name: "default"
                - name: "bridged-network"
                  model: "virtio"
                  bridge: {}
              networkInterfaceMultiqueue: true
              rng: {}
            features:
              smm:
                enabled: true
            firmware:
              bootloader:
                efi: {}
            machine:
              type: "pc-q35-rhel9.2.0"
            resources:
              requests:
                memory: ${VM_RAM}
          evictionStrategy: "LiveMigrate"
          networks:
            - name: "default"
              pod: {}
            - name: "bridged-network"
              multus:
                networkName: "sc23-eda-demo/br1"
          terminationGracePeriodSeconds: 180
          volumes:
            - dataVolume:
                name: "${NAME}"
              name: "rootdisk"
            - name: "additional-disk"
              dataVolume:
                name: "${NAME}-additional-disk"
            - name: "cloudinitdisk"
              cloudInitNoCloud:
                userData: |
                  #cloud-config
                  preserve_hostname: true
                  ssh_pwauth: true
                  user: sysadmin
                  password: redhat
                  chpasswd:
                    expire: false
                  users:
                    - name: sysadmin
                      plain_text_passwd: redhat
                      lock_passwd: false
                      sudo: ALL=(ALL) NOPASSWD:ALL
                  disk_setup:
                    /dev/vdc:
                      table_type: 'mbr'
                      layout: [100]
                      overwrite: True
                  fs_setup:
                    - filesystem: 'ext4'
                      device: '/dev/vdc1'
                  write_files:
                    - path: /tmp/send_webhook.sh
                      content: |
                        #!/bin/bash
                        curl -X POST -d '{"source": "ocpvirt", "instanceName": "'$(hostname -f)'" }' ${WEBHOOK_URL}
                      permissions: '0755'
                  mounts:
                    - [ /dev/vdc1, /myfilesystem ]
                  runcmd:
                    - hostnamectl set-hostname $(hostname -f)
                    - /bin/bash /tmp/send_webhook.sh
                    - systemctl restart NetworkManager

parameters:
  - name: "NAME"
    description: "VM name"
    generate: "expression"
    from: "rhel9-vm"
  - name: "WEBHOOK_URL"
    description: "Webhook to call after provisioning"
    value: http://YOUR_EDA_HOSTNAME:5000/endpoint
  - name: "VM_CPU"
    description: CPU Count for VM
    value: "4"
  - name: "VM_RAM"
    description: Memory Count for VM
    value: "4Gi"
